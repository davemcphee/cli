#!/usr/bin/env bash

case "${ARGUMENT}" in
"id")
  api_curl GET /project/$3
  ;;

"get")
  api_curl GET /project/name/$3
  ;;

"list")
  api_curl GET /project
  ;;

"init")
  NAME="$3"
  ORGANIZATION="$4"
  if [ -d "${NAME}" ]; then 
    echo "==> ERROR: Directory ${NAME} exists."
    exit 1
  fi
  echo "===> Creating Project ${NAME} ..."
  api_curl POST /project name=${NAME} organization_name=${ORGANIZATION}
  if [ "${CURL_CODE}" == "200" ]; then
    PROJECTID=`echo "${CURL_RESPONSE}" | jq -r '.["id"]'`
    mkdir ${NAME}
    cd ${NAME}
    git init --quiet

    echo "===> Writing configuration file longboat.cfg"
    echo "# Longboat API Configuration" > longboat.cfg
    echo "LONGBOAT_PROJECT=\"${PROJECTID}\"" >> longboat.cfg
    git add longboat.cfg

    echo "===> Adding .gitignore file ..."
    cp ${BOATDIR}/files/gitignore .gitignore
    git add .gitignore

    echo "===> Adding initial ansible.cfg ..."
    cp ${BOATDIR}/files/ansible.cfg ansible.cfg
    git add ansible.cfg

    echo "===> Git cloning Ansible roles ..."
    git clone --quiet https://github.com/longboatio/roles.git

    echo "===> Initial git commit ..."
    git commit --quiet -m "Longboat project ${NAME} initialized"

    echo "===> Done! Test is with: cd ${NAME} ; boat doctor"
  else
    echo "===> ERROR: Could not create project"
    exit 1
  fi
  ;;

"create")
  api_curl POST /project name=$3 organization_name=$4
  ;;

"delete")
  api_curl GET /project/$3
  if [ "${CURL_CODE}" == "200" ]; then
    api_curl DELETE /project/$3
  fi
  ;;

"help")
cat << ENDOFHELP
usage: boat project <command> <args>

  boat project list

      List all your projets across all organisations.
      Example: boat project list

  boat project id <project-id>

      Get project by id
      Example: boat project id 12345

  boat project get <project-name>

      Get project by name
      Example: boat project get example-corp

  boat project init <projectname> <organization-name>

      Create, initialize and setup a new project locally.
      Example: boat project init new-project example-corp

  boat project create <project-name> <organization-name>

      You are most likely looking for 'boat project init' instead of create!
      Creates an empty project, with not initialization at all.
      Example: boat project create new-project example-corp

  boat project delete <project-id>

      Delete a project by it's ID. Note that projects that has one or more
      environments, can't be deleted.

ENDOFHELP
  exit 0
  ;;
*)
  echo "ERROR: Unknown project command!"
  echo ""
  echo "List of available project commands: boat project help"
  echo "Online documentation: ${LONGBOAT_DOCS}"
  exit 1
  ;;
esac
