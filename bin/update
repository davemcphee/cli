#!/usr/bin/env bash

if [ ! -f "longboat.cfg" ]; then
  echo "ERROR! No longboat.cfg found in: ${PROJECTDIR}"
  exit 1
fi

if [ -d "roles" ]; then
  echo "===> Updating Longboat roles..."
  cd roles/
  git stash --quiet
  git pull --quiet
  cd ..
else
  echo "===> Downloading Longboat Roles for the first time..."
  git clone --quiet ${LONGBOAT_ROLES_REPO}
fi

# Inventories
echo "===> Updating environments..."
URL="${LONGBOAT_ENDPOINT}/${LONGBOAT_API}/config/environments/${LONGBOAT_PROJECT}"
ENVIRONMENTS=`curl --compressed -s -f -H "Authorization: ${LONGBOAT_TOKEN}" -X GET "${URL}"`
if [ $? -eq 0 ]; then
  for ENVIRONMENT in ${ENVIRONMENTS}; do
    echo "#!/bin/sh" > ${PROJECTDIR}/${ENVIRONMENT}
    echo "source \${HOME}/.longboat.cfg" >> ${PROJECTDIR}/${ENVIRONMENT}
    echo "\${LONGBOAT_PATH}/boat inventory ${ENVIRONMENT}" >> ${PROJECTDIR}/${ENVIRONMENT}
    chmod 755 ${PROJECTDIR}/${ENVIRONMENT}
  done
else
  echo "ERROR: Could not get environments!"
  echo "       Try running 'boat doctor' to test that API works."
fi

# Gitignore
# FIXME: Get from API
echo "===> Updating .gitignore file..."
cp ${BOATDIR}/files/gitignore .gitignore

# Ansible.cfg
# FIXME: Get from API

# Playbooks
# FIXME: Deploy playbook(s)

