#!/usr/bin/env bash

# Check for curl
command -v curl > /dev/null
if [ $? -eq 0 ]; then
  CURL_VERSION=`curl --version | head -1 | awk '{print $2}'`
  if ! version_gt ${CURL_VERSION} 7.55.0; then
    error "curl v7.55.0 or greater is required, but found v${CURL_VERSION}"
    space "Read more in FIXME: Link to docs"
    exit 1
  fi
else
  error "curl command not found!"
  space "curl is required for running the Longboat CLI tools."
  space "Read more on FIXME: Link to docs"
  exit 1
fi

# Check for jq
command -v jq > /dev/null
if [ $? -ne 0 ]; then
  error "jq command not found!"
  space "jq is required for running the Longboat CLI tools."
  space "Please install jq: FIXME: Link to docs"
  exit 1
fi

if [ -z "${LONGBOAT_TOKEN}" ]; then
  if [ -f "${USERCONFIG}" ]; then
    echo ""
    echo "Config file already exists in ${USERCONFIG}"
  else
    # Ask for Token
    echo "==> Longboat requires an API token. If you don't have one, get it"
    echo "==> from: https://gorm.longboat.io/token/list"
    echo ""
    echo -n "Longboat API Token: "
    read TOKEN

    # Testing provided token against the API
    echo ""
    echo "==> Testing provided token with API request.."
    mkdir -p ${USERCONFIGDIR}
    CURL_SILENT=true
    CURL_CONTINUE=true
    LONGBOAT_TOKEN="${TOKEN}"
    api_curl GET /doctor/user
    if [ "${CURL_CODE}" == "200" ]; then
      echo -e "==> Token belongs to: ${GREEN}${CURL_RESPONSE}${NC}"
    else
      echo "Longboat API did not respond correctly - error was:"
      echo "${CURL_RESPONSE}" | jq -r '.["errors"]'
      exit 1
    fi

    # Ensure correct directory and file permissions
    echo -e "==> Writing user config ${BLUE}${USERCONFIG}${NC}"
    touch ${USERCONFIG}
    user_dir_perms

    # Write Longboat config file
    echo "# Longboat API Configuration" > ${USERCONFIG}
    echo "LONGBOAT_TOKEN=\"${TOKEN}\"" >> ${USERCONFIG}
    echo "LONGBOAT_PATH=\"${BOATDIR}\"" >> ${USERCONFIG}

    # Update user local files
    user_hosts_update

    echo "==> Done."
    exit 0
  fi
else
  echo ""
  echo "LONGBOAT_TOKEN is already set."
fi

echo ""
echo "If you want to change your token, simply update the"
echo "content of LONGBOAT_TOKEN in the file: ${USERCONFIG}"

exit 1
