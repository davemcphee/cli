#!/usr/bin/env bash

CURL_SILENT=true

info "Updating user files"
user_hosts_update

if [ -z "${LONGBOAT_PROJECT}" ]; then
  info "Skipping project updates, not in a Longboat project directory."
  exit 0
fi

if [ "${LONGBOAT_PULL_ENVS}" == "true" ]; then
  info "Updating environments"
  api_curl GET /environments "project_id=${LONGBOAT_PROJECT}"
  if [ "${CURL_CODE}" == "200" ]; then
    ENVIRONMENTS=$(echo "${CURL_RESPONSE}" | jq -r '.[]["name"]')
    echo "${ENVIRONMENTS}" | while read -r ENVNAME ; do
      {
        echo "#!/usr/bin/env bash"
        echo ""
        echo "# DO NOT CHANGE THIS FILE!"
        echo "# Changes will be overwritten on: boat pull"
        echo ""
        echo "source \${HOME}/.longboat/config"
        echo "\${LONGBOAT_PATH}/boat inventory ${ENVNAME}"
      } > "${PROJECTDIR}/${ENVNAME}"
      chmod 755 "${PROJECTDIR}/${ENVNAME}"
    done
  else
    error "Could not get environments from api:"
    echo_json "${CURL_RESPONSE}"
  fi
fi

if [ "${LONGBOAT_PULL_ROLES}" == "true" ]; then
  find roles -maxdepth 1 -not -path "roles" | while read -r ROLE ; do
    if [ -f "${ROLE}/.git/config" ]; then
      info "Updating ${ROLE}"
      cd "./${ROLE}" || exit
      git pull --quiet
      cd ../../ || exit
    fi
  done
fi

