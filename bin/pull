#!/usr/bin/env bash

CURL_SILENT=true

echo "==> Updating users hosts file ~/.longboat/hosts..."
user_dir_perms
user_hosts_update

if [ -z "${LONGBOAT_PROJECT}" ]; then
  echo "==> Skipping project updates, not in a Longboat project directory."
else
  echo "==> Building environments..."
  api_curl GET /environments project_id=${LONGBOAT_PROJECT}
  if [ "${CURL_CODE}" == "200" ]; then
    echo "${CURL_RESPONSE}" | jq -r '.[]["name"]' | while read ENVNAME ; do
      echo "==> Writing: ${ENVNAME}..."
      echo "#!/usr/bin/env bash" > ${PROJECTDIR}/${ENVNAME}
      echo "" >> ${PROJECTDIR}/${ENVNAME}
      echo "# DO NOT CHANGE THIS FILE!" >> ${PROJECTDIR}/${ENVNAME}
      echo "# Changes will be overwritten every time someone does: boat pull" >> ${PROJECTDIR}/${ENVNAME}
      echo "" >> ${PROJECTDIR}/${ENVNAME}
      echo "source \${HOME}/.longboat/config" >> ${PROJECTDIR}/${ENVNAME}
      echo "\${LONGBOAT_PATH}/boat inventory ${ENVNAME}" >> ${PROJECTDIR}/${ENVNAME}
      chmod 755 ${PROJECTDIR}/${ENVNAME}
    done
  fi

  mkdir -p ./roles
  if [ -d ./roles/longboat ]; then
    echo "==> Git pull Longboat Ansible roles..."
    cd ./roles/longboat
    git pull --quiet
  else
    echo "==> Git clone Longboat Ansible roles..."
    git clone --quiet https://github.com/longboatio/roles.git roles/longboat
  fi

fi
