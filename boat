#!/usr/bin/env bash

COMMAND="$1"
ARGUMENT="$2"

BOATDIR=`dirname $0`
PROJECTDIR=`pwd`
USERCONFIGDIR="${HOME}/.longboat"
USERCONFIG="${USERCONFIGDIR}/config"
USERHOSTS="${USERCONFIGDIR}/hosts"

# Subroutines
source ${BOATDIR}/lib/subroutines || error "Could not load ${BOATDIR}/lib/subroutines"

# Default Longboat configuration
source ${BOATDIR}/etc/defaults.cfg || error "Could not load ${BOATDIR}/etc/defaults.cfg"

# User configuration
if [ -f "${USERCONFIG}" ]; then
  source ${USERCONFIG}
fi

# Project configuration
if [ -f "${PROJECTDIR}/longboat.cfg" ]; then
  source ${PROJECTDIR}/longboat.cfg
fi

# Check for -h or --help
for HELPARG in "$@"; do
  case "${HELPARG}" in
  "-h")
    source ${BOATDIR}/bin/help ; exit 0 ;;
  "--help")
    source ${BOATDIR}/bin/help ; exit 0 ;;
  esac
done

case "${COMMAND}" in
"doctor")
  source ${BOATDIR}/bin/doctor ; exit $? ;;
"inventory")
  source ${BOATDIR}/bin/inventory ; exit $? ;;
"init")
  source ${BOATDIR}/bin/init ; exit $? ;;
"pull")
  source ${BOATDIR}/bin/pull ; exit $? ;;
"sshkey")
  source ${BOATDIR}/bin/sshkey ; exit $? ;;
"org")
  source ${BOATDIR}/bin/organization ; exit $? ;;
"domain")
  source ${BOATDIR}/bin/domain ; exit $? ;;
"rr")
  source ${BOATDIR}/bin/rr ; exit $? ;;
"project")
  source ${BOATDIR}/bin/project ; exit $? ;;
"env")
  source ${BOATDIR}/bin/environment ; exit $? ;;
"host")
  source ${BOATDIR}/bin/host ; exit $? ;;
"group")
  source ${BOATDIR}/bin/group ; exit $? ;;
"auth")
  source ${BOATDIR}/bin/auth ; exit $? ;;
"upgrade")
  echo "==> Pulling latest version of Longboat CLI..."
  cd ${BOATDIR} && git pull -q
  echo "==> We highly recommend running: boat doctor"
  echo "==> It verifies Longboat CLI requirements, which might have changed."
  ;;
*)
  echo "ERROR! Unknown command. Try: boat -h"
  echo "or the online documentation: ${LONGBOAT_DOCS}"
  exit 1
  ;;
esac

